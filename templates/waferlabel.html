{% extends "base.html" %}

{% block title %}SWLY Label{% endblock %}


{% block head %}
    {{ super() }}
    <style>    
        .container {
            width: 100%;
            height: 100%;
        }

        .card-body {
            overflow-y: auto;
            overflow-x: auto;
            overflow: hidden;
        }
    /* Hiding the checkbox, but allowing it to be focused */
    .badgebox
    {
        opacity: 0;
    }

    .badgebox + .badge
    {
        /* Move the check mark away when unchecked */
        text-indent: -999999px;
        /* Makes the badge's width stay the same checked and unchecked */
        width: 27px;
    }

    .badgebox:focus + .badge
    {
        /* Set something to make the badge looks focused */
        /* This really depends on the application, in my case it was: */
        
        /* Adding a light border */
        box-shadow: inset 0px 0px 5px;
        /* Taking the difference out of the padding */
    }

    .badgebox:checked + .badge
    {
        /* Move the check mark back when checked */
        text-indent: 0;
    }
    /* The customcheck */
    .customcheck {
        display: block;
        position: relative;
        padding-left: 35px;
        margin-bottom: 12px;
        cursor: pointer;
        font-size: 22px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /* Hide the browser's default checkbox */
    .customcheck input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }

    /* Create a custom checkbox */
    .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 25px;
        width: 25px;
        background-color: #eee;
        border-radius: 5px;
    }

    /* On mouse-over, add a grey background color */
    .customcheck:hover input ~ .checkmark {
        background-color: #ccc;
    }

    /* When the checkbox is checked, add a blue background */
    .customcheck input:checked ~ .checkmark {
        background-color: #02cf32;
        border-radius: 5px;
    }

    /* Create the checkmark/indicator (hidden when not checked) */
    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }

    /* Show the checkmark when checked */
    .customcheck input:checked ~ .checkmark:after {
        display: block;
    }

    /* Style the checkmark/indicator */
    .customcheck .checkmark:after {
        left: 9px;
        top: 5px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 3px 3px 0;
        -webkit-transform: rotate(45deg);
        -ms-transform: rotate(45deg);
        transform: rotate(45deg);
    }
    </style>
{% endblock %}


{% block page_content %}
    <main role="main" style="padding-top: 70px;">
        <!-- <div class="row">
            <div class="col">
                {{markdown_data.text|safe}}
            </div>
        </div> -->
        
        <!-- <h2>lot_id {{lot_id}} and wafer_id {{process_id}}.</h2> -->

        <!-- <h4 class="bg-primary text-white p-2 mb-1 text-center">SWLY Marker</h4> -->
        <div class="container no-lr-margin">
            <div class="row">
                <div class="col-md-4 mb-2 p-1 no-lr-margin">
                    <div class="card">
                        <div class="card-header" style="height: 25px; padding: 1px 12px;  font-size: 14px;">
                            {{lot_id}}
                        </div>
                        <div class="card-body">
                            <div id="wafer-map" style="width: 100%; height: 100%;"></div>
                        </div>
                        <div class="card-footer">
                            <div class="row no-gutters">
                                <div class="col px-1">
                                    <button id="recenterButton" type="button" class="btn btn-primary">Reset</button>
                                </div>
                                <div class="col px-1">
                                    <label class="customcheck">Shot
                                        <input type="checkbox" checked="checked" id="shotDataCheckbox">
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                                <div class="col px-1">
                                    <input type="text" id="digitalInput" class="form-control form-control-sm" placeholder="Die width" value="0.025">
                                </div>
                                <div class="col px-1">
                                    <select id="colorDropdown" class="form-control form-control-sm">
                                        <option value="White">White</option>
                                        <option value="red">Red</option>
                                        <option value="blue">Blue</option>
                                        <option value="black">Black</option>
                                        <option value="yellow">Yellow</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-2 p-1 no-lr-margin">
                    <div class="card">
                        <div class="card-body">
                            <form id="submit_swly_form" method="POST" action="/submit_swly_label_data/">
                                <div class="mb-3">
                                    {{process_id}} - {{lot_id}}
                                </div>
                                <div class="mb-3">
                                    <label for="wafer">Wafer ID:</label>
                                    <select id="wafer" class="form-control select2" name="wafers" multiple>
                                        {% for wafer_id in wafer_ids %}
                                            {% if wafer_id in selected_wafer_ids %}
                                                <option value="{{ wafer_id }}" selected>{{ wafer_id }}</option>
                                            {% else %}
                                                <option value="{{ wafer_id }}">{{ wafer_id }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="swly_bin">Select SWLY BINS:</label>
                                    <select id="swly_bin" class="form-control select2" name="swly_bins" multiple>
                                        {% for swly_bin in swly_bins %}
                                                <option value="{{ swly_bin }}">{{ swly_bin }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="swly_label">Select Labels:</label>
                                    <select id="swly_label" class="form-control select2" name="swly_labels" multiple>
                                        {% for swly_label in swly_labels %}
                                                <option value="{{ swly_label }}">{{ swly_label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="exampleFormControlTextarea1" class="form-label">Description</label>
                                    <textarea class="form-control" required name="description" id="exampleFormControlTextarea1" rows="3">{{description}}</textarea>
                                    <div id="help" class="form-text">Please provide complete Job description,requirements,perks and benefits.</div>
                                </div>
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-lg-4 order-md-last">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-primary">Top Failure Bins</span>
                        <span class="badge bg-primary rounded-pill">3</span>
                    </h4>

                    <ul class="list-group mb-3">
                        {% for item in top_bin_items %}
                            <li class="list-group-item d-flex justify-content-between lh-sm">
                                <div>
                                    <h6 class="my-0">{{ item.BIN_ITEM }}</h6>
                                    <small class="text-muted">Dynamic BIN_GROUP</small>
                                </div>
                                <span class="text-muted">{{ item.BIN_VALUE }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

            </div>

        </div>

    </main>
{% endblock %}


{% block scripts %}
{{ super() }}
<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
    // Declare svg and zoom in a wider scope to make them accessible by all functions
    let svg;
    let zoom;
    let g;
    let s;

    function drawWaferMap(data, shotData, containerId) {
        const svgContainer = document.getElementById(containerId);
        if (!svgContainer) {
            console.error("Container not found:", containerId);
            return;
        }
        const max_x = d3.max(data, ({ x }) => x);
        const max_y = d3.max(data, ({ y }) => y);
        const min_x = d3.min(data, ({ x }) => x);
        const min_y = d3.min(data, ({ y }) => y);
        const radius = 150;
        
        // Initialize svg using wider scope variable without const
        svg = d3.create("svg")
            .attr("viewBox", [-150, -150, 300, 300]);

        const c1 = svg.append("circle")
            .style("fill", "gray")
            .style("stroke", "black")
            .style("stroke-width", 0.025)
            .attr("r", radius + 0.2)
            .attr("cx", 0.5)
            .attr("cy", 0.5);

        const c2 = svg.append("circle")
            .style("fill", "gray")
            .style("stroke", "black")
            .style("stroke-width", 0.025)
            .attr("r", radius)
            .attr("cx", 0.5)
            .attr("cy", 0.5);

        g = svg.append("g").selectAll("rect")
            .data(data)
            .join("rect")
            .attr("x", ({x}) => x)
            .attr("y", ({y}) => y)
            .attr("width", {{ rectWidth|safe }})
            .attr("height", {{ rectHeight|safe }})
            .attr("fill", "blue")
            .attr("stroke", "red")
            .attr("fill-opacity", 0)
            .attr("stroke-width", 1);

        s = svg.append("g").selectAll("rect")
            .data(shotData)
            .join("rect")
            .attr("x", ({x}) => x)
            .attr("y", ({y}) => y)
            .attr("width", {{ shotWidth|safe }})
            .attr("height", {{ shotHeight|safe }})
            .attr("fill", ({color}) => color)
            .attr("stroke", "white")
            .attr("stroke-width", 0.025)
            .attr("display", "none");  // Initially hide the shotData
        
        // add annotation on the wafer when mouse hover
        svg.selectAll("rect")
                .data(data)
                .append("svg:title")
                .text(({mouseover}) => mouseover);

        // Initialize zoom using wider scope variable
        zoom = d3.zoom()
            .extent([[-100, -100], [500, 500]])
            .scaleExtent([-1, 8])
            .on("zoom", function(event) {
                g.attr("transform", event.transform);
                s.attr("transform", event.transform);
                c1.attr("transform", event.transform);
                c2.attr("transform", event.transform);
            });

        svg.call(zoom);

        svg.on("mousedown", function() {
                    // Prevent drag
                    d3.event.preventDefault();
                });

        document.getElementById(containerId).appendChild(svg.node());
    }

    // Define the resetZoom function
    function resetZoom() {
        if (svg && zoom) {
            svg.transition()
                .duration(750) // Smooth transition duration
                .call(zoom.transform, d3.zoomIdentity); // Resets zoom and pan
        }
    }

    // Define a function to update the stroke width of rectangles based on the input value
    function updateStrokeWidth(value) {
        // Update the stroke width of rectangles based on the input value
        g.attr("stroke-width", value);
    }

    // Define a function to update the stroke color of rectangles based on the select dropdown
    function updateStrokeColor(value) {
        // Update the stroke color of rectangles based on the selected value from the dropdown
        g.attr("stroke", value);
    }

    // Define a function to update the fill color of rectangles based on the select dropdown items 
    function updateFillColor(selectedBins) {
        console.log("Active: ", selectedBins);
        // Iterate through each rectangle and update fill color based on selected bins
        g.attr("fill", function(d) {
            // Check if the bin_value matches any of the selected values
            if (selectedBins.includes(d.bin_value)) {
                return "red"; // Change the fill color to red
            } else {
                return d.color; // Keep the original fill color
            }
        });
    }


        // Bind the resetZoom function to the button click event
        document.addEventListener('DOMContentLoaded', function() {
            // Assuming the button has an ID 'recenterButton'
            document.getElementById('recenterButton').addEventListener('click', function() {
                resetZoom();
            });

        // Bind the updateStrokeWidth function to the keyup event of digitalInput
        document.getElementById('digitalInput').addEventListener('keyup', function(event) {
            // Check if the key pressed is Enter (key code 13)
            if (event.keyCode === 13) {
                // Get the value entered in the input
                const inputValue = parseFloat(event.target.value);
                // Call the updateStrokeWidth function with the input value
                updateStrokeWidth(inputValue);
            }
        });

        // Bind the updateStrokeColor function to the change event of colorDropdown
        document.getElementById('colorDropdown').addEventListener('change', function(event) {
            // Get the selected value from the dropdown
            const selectedColor = event.target.value;
            // Call the updateStrokeColor function with the selected color value
            updateStrokeColor(selectedColor);
        });

        // Bind the updateFillColor function to the change event of swly_bin dropdown
        // select2 

        // Assuming rawData and containerId are defined, call drawWaferMap to initialize the wafer map
        const rawData = {{ waferData|safe }};
        const shotData = {{ shotData|safe }};
        drawWaferMap(rawData,shotData, 'wafer-map'); // Make sure 'wafer-map' matches the ID of your SVG container
    });
</script>

    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                placeholder: "Select Wafer",
                allowClear: true
            });
        })
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Bind the event listener for the swly_bin dropdown
            $('#swly_bin').on('change', function () {
                // Get an array of selected bin values
                const selectedBins = $(this).val();
                // console.log("Dropdown changed:", selectedBins);
                // Call updateFillColor with the array of selected bin values
                updateFillColor(selectedBins);
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const form = document.getElementById('submit_swly_form');
            // Optional: Configure Toastr
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": true,
                "positionClass": "toast-top-left",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "500",
                "timeOut": "1000",
                "extendedTimeOut": "500",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };

            form.addEventListener('submit', function(e) {
                e.preventDefault();  // Prevent default form submission
                const formData = new FormData(this);
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Assuming 'data' contains a message for successful submission
                    toastr.success(data.message, 'Success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    toastr.error('An error occurred while submitting the form.', 'Error');
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const shotDataCheckbox = document.getElementById('shotDataCheckbox');
            
            shotDataCheckbox.addEventListener('change', function() {
                console.log(shotDataCheckbox);
                if (this.checked) {
                    s.attr('display', ''); // Show shot data
                } else {
                    s.attr('display', 'none'); // Hide shot data
                }
            });
        });
    </script>
    

    <script>
        var summaryziedByWaferID = {{ summaryzied_by_waferID | safe }};
    </script>

    <script>
        $(document).ready(function() {        
            $('#wafer').on('change', function() {
                var selectedWaferIDs = $(this).val();
                var combinedData = {};
        
                // Combine data for selected wafers
                selectedWaferIDs.forEach(waferID => {
                    // Find the data for the selected wafer ID
                    var waferData = summaryziedByWaferID.find(w => w.WAFER_ID === waferID);
                    if (waferData) {
                        // Iterate over the Data object within the found wafer data
                        Object.entries(waferData.Data).forEach(([binItem, binValue]) => {
                            if (!combinedData[binItem]) {
                                combinedData[binItem] = [];
                            }
                            combinedData[binItem].push(binValue);
                        });
                    }
                });
        
                // Calculate mean for each BIN_ITEM and sort to find top 10
                var topItems = Object.keys(combinedData).map(binItem => {
                    var total = combinedData[binItem].reduce((sum, current) => sum + current, 0);
                    var mean = total / combinedData[binItem].length;
                    return { BIN_ITEM: binItem, BIN_VALUE: mean };
                }).sort((a, b) => b.BIN_VALUE - a.BIN_VALUE).slice(0, 10);
        
                // Update the HTML list
                var listGroup = $('.list-group.mb-3').empty();
                topItems.forEach(item => {
                    $('<li>', {
                        'class': 'list-group-item d-flex justify-content-between lh-sm',
                        html: `<div><h6 class="my-0">${item.BIN_ITEM}</h6><small class="text-muted">Mean BIN VALUE</small></div><span class="text-muted">${item.BIN_VALUE.toFixed(2)}</span>`
                    }).appendTo(listGroup);
                });
            });
        });
        </script>

{% endblock %}

