{% extends "base.html" %}

{% block title %}SWLY Label{% endblock %}


{% block head %}
{{ super() }}
<style>

    .aspect-ratio-box {
        position: relative;
        width: 100%;
        padding-top: 56.25%; /* 16:9 Aspect Ratio */
    }
    
    .aspect-ratio-box .content {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
    }

    .node-color-box {
        width: 12px;
        height: 12px;
        display: inline-block;
        margin-right: 5px;
        vertical-align: middle;
    }

    .card-body {
        overflow-x: auto;  /* Enables horizontal scrolling*/
        white-space: nowrap;  /* Prevents text from wrapping onto the next line*/
    }
    
    .jstree-node {
        display: inline-block;  /* Ensures that nodes are treated as inline elements*/
        vertical-align: top;
    }

    .jstree-anchor {
        white-space: nowrap;  /* Prevents individual tree node labels from wrapping*/
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
{% endblock %}


{% block page_content %}
<main role="main" style="padding-top: 70px;">
    <div class="container-fluid">
        <div class="row">
            <form id="dataForm_wafermap">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="processId">root_lot_id</label>
                        <input type="text" class="form-control" id="root_lot_id" name="root_lot_id" value="{{root_lot_id}}" required>
                    </div>
                    <div class="col-md-2">
                        <label for="stepId">Step ID</label>
                        <select id="stepId" class="form-control" name="stepId">
                            {% for step_id in step_ids %}
                                <option value="{{ step_id }}" selected>{{ step_id }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="startDate">Start Date</label>
                        <div class="input-group date" id="startDatepicker">
                            <input type="text" class="form-control" id="startDate" name="startDate">
                            <span class="input-group-text bg-light d-block">
                                <i class="fa fa-calendar" id="startCalendarIcon"></i>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="endDate">End Date</label>
                        <div class="input-group date" id="endDatepicker">
                            <input type="text" class="form-control" id="endDate" name="endDate"/>
                            <span class="input-group-text bg-light d-block">
                                <i class="fa fa-calendar" id="endCalendarIcon"></i>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="submitButton"></label>
                        <button type="submit" class="btn btn-primary mt-md-4">Retrieve</button>
                    </div>
                </div>
            </form>
            <hr/>
        </div>
        <div class="row">
            <div class="col-md-10">
                <div class="row">
                    {% for i in range(1, 26) %}
                        <div class="col-md-3 mb-2 p-1">
                            <div class="card">
                                <div class="card-header wafer-card-header" id="head-{{ root_lot_id }}-W{{ '%02d' | format(i) }}" data-id="{{ root_lot_id }}-W{{ '%02d' | format(i) }}" style="height: 25px; padding: 1px 12px;  font-size: 12px;">
                                    {{ root_lot_id }}-W{{ '%02d' | format(i) }}
                                </div>
                                <div class="card-body">
                                    <div id="{{root_lot_id}}-{{ i }}"></div>
                                </div>
                                <div class="card-footer">
                                    <button type="button" class="btn btn-primary">Click</button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-2" id="tree-view">
                <div class="card">
                    <div class="card-body">
                        test
                    </div>
                </div>

            </div>
        </div>
    </div>
</main>
{% endblock %}


{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

    <script>
        $(document).ready(function() {
            $('.select2').select2({
                placeholder: "Select process IDs",
                allowClear: true,
            });
        });
    </script>
    <script>
        /* const rawData = {{ waferData|safe }};
        // console.log("Raw Data:", rawData);
        const rect_width = {{ rectWidth|safe }};
        const rect_height = {{ rectHeight|safe }}; */

    </script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        let svg;
        let zoom;
        let g;
        let s;
        
        function drawWaferMap(data, rect_width, rect_height, containerId) {
            const svgContainer = document.getElementById(containerId);
            // console.log(containerId);
            if (!svgContainer) {
                console.error("Container not found:", containerId);
                return;
            }

            // Remove any existing SVG to prevent duplicates
            while (svgContainer.firstChild) {
                svgContainer.removeChild(svgContainer.firstChild);
            }

            // console.log(max_x)
            const radius = 150;
            
            // Initialize svg using wider scope variable without const
            const svg = d3.create("svg")
            .attr("viewBox", [-150, -150, 300, 300])
            .style("width", "100%")
            .style("height", "100%");

            const c1 = svg.append("circle")
            .style("fill", "gray")
            .style("stroke", "black")
            .style("stroke-width", 0.025)
            .attr("r", radius + 0.2)
            .attr("cx", 0.5)
            .attr("cy", 0.5);

            const c2 = svg.append("circle")
            .style("fill", "gray")
            .style("stroke", "black")
            .style("stroke-width", 0.025)
            .attr("r", radius)
            .attr("cx", 0.5)
            .attr("cy", 0.5);

            const g = svg.append("g").selectAll("rect")
            .data(data)
            .join("rect")
            .attr("x", ({x}) => x)
            .attr("y", ({y}) => y)
            .attr("width", rect_width )
            .attr("height",rect_height )
            .attr("fill", ({color}) => color)
            .attr("stroke", "white")
            .attr("stroke-width", 0.025)

            svg.selectAll("rect")
                .data(data)
                .append("svg:title")
                .text(({mouseover}) => mouseover);

            // Define the zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([1, 8])  // Limits for zooming
                .on("zoom", function(event) {
                    // Apply scale only, remove any translation
                    svg.selectAll("circle, g")
                    .attr("transform", `scale(${event.transform.k})`);
                });

            svg.call(zoom);

            /*
            svg.call(d3.zoom()
                .extent([[0, 0], [200, 200]])
                .scaleExtent([1, 8])
                .on("zoom", zoomed));

            function zoomed({ transform }) {
                g.attr("transform", transform);
                c1.attr("transform", transform);
                c2.attr("transform", transform);
            }
            */
            svg.on("mousedown", function() {
                // Prevent drag
                d3.event.preventDefault();
            });

            document.getElementById(containerId).appendChild(svg.node());
            // svgContainer.appendChild(svg.node());
        }

        function prepareJsTreeData(binListTree) {
            let treeData = [];
            for (let category in binListTree) {
                let children = [];
                let categoryColor = binListTree[category].color;
                for (let bin in binListTree[category].BIN) {
                    children.push({
                        "text": `<span class='node-color-box' style='background-color:${categoryColor};'>&nbsp;&nbsp;&nbsp;</span> ${bin} (${binListTree[category].BIN[bin]})`,
                        "icon": false
                    });
                }
                treeData.push({
                    "text": `<span class='node-color-box' style='background-color:${categoryColor};'>&nbsp;&nbsp;&nbsp;</span> ${category}`,
                    "children": children,
                    "icon": true,
                    "state": {"opened": true}
                });
            }
            return treeData;
        }

        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById('dataForm_wafermap');
        
            form.addEventListener('submit', function(event) {
                event.preventDefault();  // Prevent traditional form submission
                var formData = {
                    root_lot_id: $('#dataForm_wafermap #root_lot_id').val(),
                    step_id: $('#dataForm_wafermap #stepId').val(),
                    startDate: $('#dataForm_wafermap #startDate').val(),
                    startDate: $('#dataForm_wafermap #endDate').val(),
                };

                fetch('/UpdateWaferMap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    updateWafermaps(data.waferData, data.width, data.height);  // Assuming 'waferData' is part of the JSON response
                    updateCardHeaders("new_lot");
                    updateBinTreeList(data.bin_list_tree);
                })
                .catch(error => console.error('Error:', error));
            });
        
            function updateWafermaps(data, width, height) {
                for (let i = 1; i <= 25; i++) {
                    const waferMapId = `{{root_lot_id}}-${i}`;
                    if (data.hasOwnProperty(waferMapId)) {
                        drawWaferMap(data[waferMapId], width, height, waferMapId);
                    } else {
                        console.log(`No data available for ${waferMapId}`);
                    }
                }
            }

            function updateCardHeaders(newRootLotId) {
                console.log('Updating card headers...');
                $(".wafer-card-header").each(function() {  
                    // Check if jQuery correctly identifies and accesses each card header
                    let currentId = $(this).attr("data-id");  // Use .attr() to see if there's a discrepancy with .data()
                    console.log("Current ID:", currentId);  // This should log each ID, or undefined if there's an issue
            
                    if (currentId) {
                        let parts = currentId.split('-');
                        let newHeader = newRootLotId + '-' + parts[1];
                        $(this).text(newHeader);  // Update the text of the header
                        $(this).data("id", newHeader);  // Update the data-id attribute if needed
                    }
                });
            }
            
            function updateWaferColors(selectedLabels) {
                d3.selectAll("rect").each(function(d) {
                    if (selectedLabels.includes(d.bin_value)) {
                        // Keep original color if bin_value is in the selected labels
                        d3.select(this).style('fill', d.color);
                    } else {
                        // Change color to white if bin_value is not in the selected labels
                        d3.select(this).style('fill', 'white');
                    }
                });
            }

            function updateBinTreeList(binTreeData){
                const preparedData = prepareJsTreeData(binTreeData);
                $('#tree-view .card-body').jstree({
                    "core": {
                        "data": preparedData,
                        "check_callback": true,  // Allow all modifications
                        "themes": {
                            "name": "default",
                            "responsive": true
                        }
                    },
                    "checkbox": {
                        "keep_selected_style": true,
                        "three_state": true, // Parent selection does not depend on children selection
                        "cascade": "undetermined" // Affects parent and siblings independently
                    },
                    "plugins": ["checkbox"],  // Enable checkboxes
                    "types" : {
                        "default" : {
                            "icon" : false  // Disabling default icons
                        }
                    }
                }).on('changed.jstree', function (e, data) {
                    var selectedNodes = data.instance.get_selected(true);
                    var selectedLabels = selectedNodes.map(node => {
                        var match = node.text.match(/\b(BIN\d+)\b/);
                        return match ? match[0] : null;  // Check if match is not null before accessing index
                    }).filter(label => label !== null); // Filter out null entries
                    console.log(selectedLabels);
                    updateWaferColors(selectedLabels);
                });
            }
        });
    </script>
{% endblock %}